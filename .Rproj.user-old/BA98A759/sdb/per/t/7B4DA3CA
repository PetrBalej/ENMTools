{
    "collab_server" : "",
    "contents" : "#' Takes an emtools.species object with presence and background points, and builds a gam\n#'\n#' @param formula Standard gam formula\n#' @param species An enmtools.species object\n#' @param env A raster or raster stack of environmental data.\n#' @param test.prop Proportion of data to withhold for model evaluation\n#' @param k Dimension of the basis used to represent the smooth term.  See documentation for s() for details.\n#' @param nback Number of background points to draw from range or env, if background points aren't provided\n#' @param report Optional name of an html file for generating reports\n#' @param overwrite TRUE/FALSE whether to overwrite a report file if it already exists\n#' @param ... Arguments to be passed to gam()\n#'\n#' @export enmtools.gam\n#' @export print.enmtools.gam\n#' @export summary.enmtools.gam\n#' @export plot.enmtools.gam\n\n\nenmtools.gam <- function(species, env, f = NULL, test.prop = 0, k = 4, nback = 1000, report = NULL, overwrite = FALSE, weights = \"equal\", ...){\n\n  notes <- NULL\n\n  species <- check.bg(species, env, nback = nback)\n\n  # Builds a default formula using all env\n  if(is.null(f)){\n    smoothers <- unlist(lapply(names(env), FUN = function(x) paste0(\"s(\", x, \", k = \", k, \")\")))\n    f <- as.formula(paste(\"presence\", paste(smoothers, collapse = \" + \"), sep = \" ~ \"))\n    notes <- c(notes, \"No formula was provided, so a GAM formula was built automatically\")\n  }\n\n  #print(f)\n\n  gam.precheck(f, species, env)\n\n  test.data <- NA\n  test.evaluation <- NA\n  env.test.evaluation <- NA\n\n  if(test.prop > 0 & test.prop < 1){\n    test.inds <- sample(1:nrow(species$presence.points), ceiling(nrow(species$presence.points) * test.prop))\n    test.data <- species$presence.points[test.inds,]\n    species$presence.points <- species$presence.points[-test.inds,]\n  }\n\n  ### Add env data\n  species <- add.env(species, env)\n\n  # Recast this formula so that the response variable is named \"presence\"\n  # regardless of what was passed.\n  f <- reformulate(attr(delete.response(terms(f)), \"term.labels\"), response = \"presence\")\n\n  analysis.df <- rbind(species$presence.points, species$background.points)\n  analysis.df$presence <- c(rep(1, nrow(species$presence.points)), rep(0, nrow(species$background.points)))\n\n  if(weights == \"equal\"){\n    weights <- c(rep(1, nrow(species$presence.points)),\n                 rep(nrow(species$presence.points)/nrow(species$background.points),\n                     nrow(species$background.points)))\n  } else {\n    weights <- rep(1, nrow(species$presence.points) + nrow(species$background.points))\n  }\n\n  this.gam <- gam(f, analysis.df[,-c(1,2)], family=\"binomial\", weights = weights, ...)\n\n  suitability <- predict(env, this.gam, type = \"response\")\n\n  # This is a very weird hack that has to be done because dismo's evaluate function\n  # fails if the stack only has one layer.\n  if(length(names(env)) == 1){\n    oldname <- names(env)\n    env <- stack(env, env)\n    names(env) <- c(oldname, \"dummyvar\")\n    notes <- c(notes, \"Only one predictor was provided, so a dummy variable was created in order to be compatible with dismo's prediction function.\")\n  }\n\n  model.evaluation <- dismo::evaluate(species$presence.points[,1:2], species$background.points[,1:2],\n                               this.gam, env)\n  env.model.evaluation <- env.evaluate(species, this.gam, env)\n\n\n  if(test.prop > 0 & test.prop < 1){\n    test.evaluation <- dismo::evaluate(test.data, species$background.points[,1:2],\n                                this.gam, env)\n    temp.sp <- species\n    temp.sp$presence.points <- test.data\n    env.test.evaluation <- env.evaluate(temp.sp, this.gam, env)\n  }\n\n\n\n  output <- list(species.name = species$species.name,\n                 formula = f,\n                 analysis.df = analysis.df,\n                 test.data = test.data,\n                 test.prop = test.prop,\n                 model = this.gam,\n                 training.evaluation = model.evaluation,\n                 test.evaluation = test.evaluation,\n                 env.training.evaluation = env.model.evaluation,\n                 env.test.evaluation = env.test.evaluation,\n                 suitability = suitability,\n                 notes = notes)\n\n  class(output) <- c(\"enmtools.gam\", \"enmtools.model\")\n\n  # Doing response plots for each variable.  Doing this bit after creating\n  # the output object because plot.response expects an enmtools.model object\n  response.plots <- list()\n\n  for(i in names(env)){\n    response.plots[[i]] <- plot.response(output, env, i)\n  }\n\n  output[[\"response.plots\"]] <- response.plots\n\n  if(!is.null(report)){\n    if(file.exists(report) & overwrite == FALSE){\n      stop(\"Report file exists, and overwrite is set to FALSE!\")\n    } else {\n      cat(\"\\n\\nGenerating html report...\\n\")\n      makereport(output, outfile = report)\n    }\n  }\n\n  return(output)\n\n}\n\n# Summary for objects of class enmtools.gam\nsummary.enmtools.gam <- function(this.gam){\n\n  cat(\"\\n\\nFormula:  \")\n  print(this.gam$formula)\n\n  cat(\"\\n\\nData table (top ten lines): \")\n  print(kable(head(this.gam$analysis.df, 10)))\n\n  cat(\"\\n\\nModel:  \")\n  print(summary(this.gam$model))\n\n  cat(\"\\n\\ngam.check results:  \")\n  print(gam.check(this.gam$model))\n\n  cat(\"\\n\\nModel fit (training data):  \")\n  print(this.gam$training.evaluation)\n\n  cat(\"\\n\\nEnvironment space model fit (training data):  \")\n  print(this.gam$env.training.evaluation)\n\n  cat(\"\\n\\nProportion of data wittheld for model fitting:  \")\n  cat(this.gam$test.prop)\n\n  cat(\"\\n\\nModel fit (test data):  \")\n  print(this.gam$test.evaluation)\n\n  cat(\"\\n\\nEnvironment space model fit (test data):  \")\n  print(this.gam$env.test.evaluation)\n\n  cat(\"\\n\\nSuitability:  \\n\")\n  print(this.gam$suitability)\n\n  cat(\"\\n\\nNotes:  \\n\")\n  print(this.gam$notes)\n\n  plot(this.gam)\n}\n\n# Print method for objects of class enmtools.gam\nprint.enmtools.gam <- function(this.gam){\n\n  print(summary(this.gam))\n\n}\n\n\n# Plot method for objects of class enmtools.gam\nplot.enmtools.gam <- function(this.gam){\n\n\n  suit.points <- data.frame(rasterToPoints(this.gam$suitability))\n  colnames(suit.points) <- c(\"Longitude\", \"Latitude\", \"Suitability\")\n\n  suit.plot <- ggplot(data = suit.points, aes(y = Latitude, x = Longitude)) +\n    geom_raster(aes(fill = Suitability)) +\n    scale_fill_viridis(option = \"B\", guide = guide_colourbar(title = \"Suitability\")) +\n    coord_fixed() + theme_classic() +\n    geom_point(data = this.gam$analysis.df[this.gam$analysis.df$presence == 1,], aes(x = Longitude, y = Latitude),\n               pch = 21, fill = \"white\", color = \"black\", size = 2)\n\n  if(!(all(is.na(this.gam$test.data)))){\n    suit.plot <- suit.plot + geom_point(data = this.gam$test.data, aes(x = Longitude, y = Latitude),\n                                        pch = 21, fill = \"green\", color = \"black\", size = 2)\n  }\n\n  return(suit.plot)\n\n}\n\n# Function for checking data prior to running enmtools.gam\ngam.precheck <- function(f, species, env){\n\n  # Check to see if the function is the right class\n  if(!inherits(f, \"formula\")){\n    stop(\"Argument \\'formula\\' must contain an R formula object!\")\n  }\n\n  ### Check to make sure the data we need is there\n  if(!inherits(species, \"enmtools.species\")){\n    stop(\"Argument \\'species\\' must contain an enmtools.species object!\")\n  }\n\n  check.species(species)\n\n  if(!inherits(species$presence.points, \"data.frame\")){\n    stop(\"Species presence.points do not appear to be an object of class data.frame\")\n  }\n\n  if(!inherits(species$background.points, \"data.frame\")){\n    stop(\"Species background.points do not appear to be an object of class data.frame\")\n  }\n\n  if(!inherits(env, c(\"raster\", \"RasterLayer\", \"RasterStack\", \"RasterBrick\"))){\n    stop(\"No environmental rasters were supplied!\")\n  }\n\n  if(ncol(species$presence.points) != 2){\n    stop(\"Species presence points do not contain longitude and latitude data!\")\n  }\n\n  if(ncol(species$background.points) != 2){\n    stop(\"Species background points do not contain longitude and latitude data!\")\n  }\n}\n\n",
    "created" : 1494305699366.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3193713487",
    "id" : "7B4DA3CA",
    "lastKnownWriteTime" : 1494305744,
    "last_content_update" : 1494305744458,
    "path" : "~/GitHub/ENMTools/R/enmtools.gam.R",
    "project_path" : "R/enmtools.gam.R",
    "properties" : {
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}